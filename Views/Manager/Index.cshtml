@*@model IEnumerable<SupplyChain.Models.OrderViewModel>*@

<div class="dashboard-wrapper">
    <div class="dashboard-card">

        <div class="dashboard-header">
            <h2>Manager Dashboard</h2>

            <div>
                <a href="/Manager/Inventory" class="btn btn-primary me-2">
                    Inventory
                </a>

                <a href="/Manager/Logout" class="btn btn-danger">
                    Logout
                </a>
            </div>
        </div>

        <table class="table custom-table" id="productsTable">
            <thead>
                <tr>
                    <th>Order Id</th>
                    <th>Product</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>

            <tbody id="he"></tbody>
        </table>

    </div>
</div>

@section scripts {
    <script>
        @*$(document).ready(function () {

        var table = $('#productsTable').DataTable({

            ajax: {
                url: '@Url.Action("GetOrders","Manager")',
                type: 'GET',
                dataSrc: 'data'
            },

            columns: [
                { data: 'ID' },
                { data: 'ProductName' },
                {
                    data: 'OrderDate',
                    render: function (data) {
                        const date = new Date(parseInt(data.substr(6)))
                        return data ? date.toLocaleDateString('en-GB') : '';
                    }
                },
                {
                    data: 'Status',
                    render: function (data) {
                        if (data === "Approved")
                            return '<span class="text-success fw-bold">Approved</span>';
                        if (data === "Rejected")
                            return '<span class="text-danger fw-bold">Rejected</span>';
                        return '<span class="text-warning fw-bold">Pending</span>';
                    }
                },
                {
                    data: null,
                    render: function (data, type, row) {

                        if (row.Status !== "Pending")
                            return '';

                        return `
                            <select class="form-control status-dropdown"
                                    data-id="${row.ID}"
                                    style="width:120px; display:inline;">
                                <option value="">--Select--</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                            </select>

                            <button class="btn btn-sm btn-primary update-btn"
                                    data-id="${row.ID}">
                                Update
                            </button>
                        `;
                    }
                }
            ]
        });

        $('#productsTable').on('click', '.update-btn', function () {

            var orderId = $(this).data('id');
            var status = $(this).closest('td')
                                .find('.status-dropdown')
                                .val();

            if (!status) {
                alert("Select status first");
                return;
            }

            $.ajax({
                url: '@Url.Action("UpdateStatus","Manager")',
                type: 'POST',
                data: { orderId: orderId, status: status },
                success: function (res) {
                    if (res.success) {
                        alert("Updated Successfully");
                        table.ajax.reload();
                    }
                }
            });

        });
    });*@
        let table = null;

        $(document).ready(function () {
            loadstatus();
        });


        function loadstatus() {

            if (table !== null) {
                table.destroy();
                $("#he").empty();
            }

            $.ajax({
                url: '@Url.Action("GetOrders","Manager")',
                type: 'GET',
                success: function (res) {
                    renderStatus(res.data || res);
                    initializeDataTable();
                },
                error: function () {
                    alert("Unable to load orders");
                }
            });
        }


        function StatusModel(obj) {
            this.ID = obj.ID;
            this.ProductName = obj.ProductName;
            this.OrderDate = obj.OrderDate;
            this.Status = obj.Status;
        }

        function getDate(data) {
            if (!data) return '';
            const date = new Date(parseInt(data.substr(6)));
            return date.toLocaleDateString('en-GB');
        }

        function getStatus(data) {
            if (data === "Approved")
                return '<span class="text-success fw-bold">Approved</span>';
            if (data === "Rejected")
                return '<span class="text-danger fw-bold">Rejected</span>';
            return '<span class="text-warning fw-bold">Pending</span>';
        }

        function getAct(row) {

            if (row.Status !== "Pending")
                return '';

            return `
                <select class="form-control status-dropdown"
                        data-id="${row.ID}"
                        style="width:120px; display:inline;">
                    <option value="">--Select--</option>
                    <option value="Approved">Approved</option>
                    <option value="Rejected">Rejected</option>
                </select>

                <button class="btn btn-sm btn-primary update-btn"
                        data-id="${row.ID}">
                    Update
                </button>
            `;
        }

        function renderStatus(data) {

            let container = $("#he");
            container.empty();

            if (!data || data.length === 0) {
                container.append(`<tr><td colspan="5" class="text-center">No orders found</td></tr>`);
                return;
            }

            data.forEach(function (item) {

                let tem = new StatusModel(item);

                let html = `
                    <tr>
                        <td>${tem.ID}</td>
                        <td>${tem.ProductName}</td>
                        <td>${getDate(tem.OrderDate)}</td>
                        <td>${getStatus(tem.Status)}</td>
                        <td>${getAct(tem)}</td>
                    </tr>
                `;

                container.append(html);
            });
        }


        $('#productsTable').on('click', '.update-btn', function () {

            var orderId = $(this).data('id');

            var status = $(this).closest('td')
                .find('.status-dropdown')
                .val();

            if (!status) {
                alert("Select status first");
                return;
            }

            $.ajax({
                url: '@Url.Action("UpdateStatus","Manager")',
                type: 'POST',
                data: { orderId: orderId, status: status },
                success: function (res) {
                    if (res.success) {
                        alert("Updated Successfully");
                        loadstatus(); 
                    }
                }
            });
        });

        function initializeDataTable() {

            table = $('#productsTable').DataTable({
                pageLength: 5,
                lengthMenu: [5, 10, 25, 50],
                ordering: true,
                searching: true,
                info: true
            });
        }


    </script>
}


<style>
    /* ===== PAGE BACKGROUND ===== */
    body {
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        font-family: 'Segoe UI', sans-serif;
    }

    /* ===== WRAPPER ===== */
    .dashboard-wrapper {
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px;
    }

    /* ===== MAIN CARD ===== */
    .dashboard-card {
        width: 95%;
        max-width: 1100px;
        background: #ffffff;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    }

    /* ===== HEADER ===== */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

        .dashboard-header h2 {
            font-weight: 600;
            color: #333;
        }

    /* ===== TABLE ===== */
    .custom-table {
        border-radius: 12px;
        overflow: hidden;
    }

        .custom-table thead {
            background: #f4f6f9;
            font-weight: 600;
        }

        .custom-table tbody tr {
            transition: 0.2s ease-in-out;
        }

            .custom-table tbody tr:hover {
                background-color: #f1f5ff;
            }

    /* ===== STATUS BADGES ===== */
    .text-success {
        background-color: #e6f9f0;
        padding: 4px 10px;
        border-radius: 20px;
    }

    .text-danger {
        background-color: #ffe6e6;
        padding: 4px 10px;
        border-radius: 20px;
    }

    .text-warning {
        background-color: #fff4e6;
        padding: 4px 10px;
        border-radius: 20px;
    }

    /* ===== DROPDOWN ===== */
    .status-dropdown {
        border-radius: 20px;
        padding: 4px 10px;
        margin-right: 8px;
    }

    /* ===== UPDATE BUTTON ===== */
    .update-btn {
        border-radius: 20px;
        padding: 4px 12px;
        font-size: 13px;
    }

    /* ===== DATATABLE SEARCH BOX ===== */
    .dataTables_filter input {
        border-radius: 20px !important;
        padding: 6px 15px !important;
        border: 1px solid #ccc !important;
    }

    /* ===== PAGINATION ===== */
    .dataTables_paginate .paginate_button {
        border-radius: 50px !important;
        margin: 2px !important;
    }

</style>